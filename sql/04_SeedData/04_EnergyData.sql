INSERT INTO EnergyMeter (MeterCode, EnergyType, InstallLocation, PipeSpec, CommProtocol, RunStatus, CalibrationCycleMonths, Manufacturer, FactoryId)
VALUES
('EM-A01-001', N'电', N'主厂区总进线', NULL, 'RS485', N'正常', 12, N'华立仪表', 1),
('EM-A01-002', N'水', N'主厂区进水总管', 'DN100', 'RS485', N'正常', 24, N'宁波水表', 1),
('EM-A01-003', N'蒸汽', N'主厂区锅炉出口', 'DN50', 'RS485', N'正常', 12, N'上海自仪', 1),
('EM-A01-004', N'天然气', N'主厂区调压站', 'DN80', 'Lora', N'正常', 12, N'金卡智能', 1),
('EM-A02-001', N'电', N'北厂总进线', NULL, 'RS485', N'正常', 12, N'华立仪表', 2),
('EM-A02-002', N'水', N'北厂进水总管', 'DN80', 'RS485', N'正常', 24, N'宁波水表', 2),
('EM-A02-003', N'蒸汽', N'北厂锅炉出口', 'DN40', 'RS485', N'故障', 12, N'上海自仪', 2),
('EM-A03-001', N'电', N'光伏产业园总进线', NULL, 'RS485', N'正常', 12, N'华立仪表', 3),
('EM-A03-002', N'水', N'光伏产业园进水总管', 'DN65', 'RS485', N'正常', 24, N'宁波水表', 3),
('EM-A04-001', N'电', N'能源基地总进线', NULL, 'RS485', N'正常', 12, N'华立仪表', 4),
('EM-A04-002', N'水', N'能源基地进水总管', 'DN100', 'RS485', N'正常', 24, N'宁波水表', 4),
('EM-A04-003', N'天然气', N'能源基地调压站', 'DN100', 'Lora', N'正常', 12, N'金卡智能', 4),
('EM-A05-001', N'电', N'化工园区总进线', NULL, 'RS485', N'正常', 12, N'华立仪表', 5),
('EM-A05-002', N'水', N'化工园区进水总管', 'DN80', 'RS485', N'正常', 24, N'宁波水表', 5),
('EM-A06-001', N'电', N'高新区总进线', NULL, 'RS485', N'正常', 12, N'华立仪表', 6),
('EM-A06-002', N'水', N'高新区进水总管', 'DN50', 'RS485', N'正常', 24, N'宁波水表', 6),
('EM-A07-002', N'水', N'空港工厂进水总管', 'DN65', 'RS485', N'正常', 24, N'宁波水表', 7),
('EM-A07-003', N'蒸汽', N'空港工厂锅炉出口', 'DN40', 'RS485', N'正常', 12, N'上海自仪', 7),
('EM-A07-004', N'天然气', N'空港工厂调压站', 'DN65', 'Lora', N'正常', 12, N'金卡智能', 7),
('EM-A08-003', N'蒸汽', N'临港工厂锅炉出口', 'DN40', 'RS485', N'正常', 12, N'上海自仪', 8),
('EM-A08-004', N'天然气', N'临港工厂调压站', 'DN65', 'Lora', N'正常', 12, N'金卡智能', 8),
('EM-A09-001', N'电', N'生态城工厂总进线', NULL, 'RS485', N'正常', 12, N'华立仪表', 9),
('EM-A09-002', N'水', N'生态城工厂进水总管', 'DN65', 'RS485', N'正常', 24, N'宁波水表', 9),
('EM-A09-003', N'蒸汽', N'生态城工厂锅炉出口', 'DN40', 'RS485', N'正常', 12, N'上海自仪', 9),
('EM-A09-004', N'天然气', N'生态城工厂调压站', 'DN65', 'Lora', N'正常', 12, N'金卡智能', 9),
('EM-A10-001', N'电', N'老城区工厂总进线', NULL, 'RS485', N'正常', 12, N'华立仪表', 10),
('EM-A10-002', N'水', N'老城区工厂进水总管', 'DN50', 'RS485', N'正常', 24, N'宁波水表', 10),
('EM-A10-003', N'蒸汽', N'老城区工厂锅炉出口', 'DN40', 'RS485', N'正常', 12, N'上海自仪', 10),
('EM-A10-004', N'天然气', N'老城区工厂调压站', 'DN50', 'Lora', N'正常', 12, N'金卡智能', 10),
('EM-B01-001', N'电', N'总部总进线', NULL, 'RS485', N'正常', 12, N'华立仪表', 11),
('EM-B01-002', N'水', N'总部进水总管', 'DN100', 'RS485', N'正常', 24, N'宁波水表', 11),
('EM-B01-003', N'天然气', N'总部调压站', 'DN80', 'Lora', N'正常', 12, N'金卡智能', 11),
('EM-B02-002', N'水', N'生产基地进水总管', 'DN80', 'RS485', N'正常', 24, N'宁波水表', 12),
('EM-B02-003', N'蒸汽', N'生产基地锅炉出口', 'DN50', 'RS485', N'正常', 12, N'上海自仪', 12),
('EM-B02-004', N'天然气', N'生产基地调压站', 'DN80', 'Lora', N'正常', 12, N'金卡智能', 12),
('EM-B03-001', N'电', N'配套工厂总进线', NULL, 'RS485', N'正常', 12, N'华立仪表', 13),
('EM-B03-002', N'水', N'配套工厂进水总管', 'DN50', 'RS485', N'正常', 24, N'宁波水表', 13),
('EM-B03-004', N'天然气', N'配套工厂调压站', 'DN50', 'Lora', N'正常', 12, N'金卡智能', 13),
('EM-B04-001', N'电', N'加工分厂总进线', NULL, 'RS485', N'正常', 12, N'华立仪表', 14),
('EM-B04-002', N'水', N'加工分厂进水总管', 'DN50', 'RS485', N'正常', 24, N'宁波水表', 14),
('EM-B04-003', N'蒸汽', N'加工分厂锅炉出口', 'DN40', 'RS485', N'正常', 12, N'上海自仪', 14),
('EM-B04-004', N'天然气', N'加工分厂调压站', 'DN50', 'Lora', N'正常', 12, N'金卡智能', 14),
('EM-B05-002', N'水', N'组装工厂进水总管', 'DN65', 'RS485', N'正常', 24, N'宁波水表', 15),
('EM-B05-003', N'蒸汽', N'组装工厂锅炉出口', 'DN40', 'RS485', N'正常', 12, N'上海自仪', 15),
('EM-B05-004', N'天然气', N'组装工厂调压站', 'DN65', 'Lora', N'正常', 12, N'金卡智能', 15),
('EM-C01-001', N'电', N'沿海工厂总进线', NULL, 'RS485', N'正常', 12, N'华立仪表', 16),
('EM-C02-002', N'水', N'内陆工厂进水总管', 'DN65', 'RS485', N'正常', 24, N'宁波水表', 17),
('EM-C02-003', N'蒸汽', N'内陆工厂锅炉出口', 'DN40', 'RS485', N'正常', 12, N'上海自仪', 17),
('EM-C02-004', N'天然气', N'内陆工厂调压站', 'DN65', 'Lora', N'正常', 12, N'金卡智能', 17),
('EM-C03-001', N'电', N'丘陵工厂总进线', NULL, 'RS485', N'正常', 12, N'华立仪表', 18),
('EM-C03-002', N'水', N'丘陵工厂进水总管', 'DN50', 'RS485', N'正常', 24, N'宁波水表', 18),
('EM-C03-003', N'蒸汽', N'丘陵工厂锅炉出口', 'DN40', 'RS485', N'正常', 12, N'上海自仪', 18),
('EM-C03-004', N'天然气', N'丘陵工厂调压站', 'DN50', 'Lora', N'正常', 12, N'金卡智能', 18),
('EM-C04-001', N'电', N'平原工厂总进线', NULL, 'RS485', N'正常', 12, N'华立仪表', 19),
('EM-C04-002', N'水', N'平原工厂进水总管', 'DN65', 'RS485', N'正常', 24, N'宁波水表', 19),
('EM-C04-003', N'蒸汽', N'平原工厂锅炉出口', 'DN40', 'RS485', N'正常', 12, N'上海自仪', 19),
('EM-C04-004', N'天然气', N'平原工厂调压站', 'DN65', 'Lora', N'正常', 12, N'金卡智能', 19),
('EM-C05-001', N'电', N'枢纽工厂总进线', NULL, 'RS485', N'正常', 12, N'华立仪表', 20),
('EM-C05-002', N'水', N'枢纽工厂进水总管', 'DN80', 'RS485', N'正常', 24, N'宁波水表', 20),
('EM-C05-003', N'蒸汽', N'枢纽工厂锅炉出口', 'DN50', 'RS485', N'正常', 12, N'上海自仪', 20),
('EM-C05-004', N'天然气', N'枢纽工厂调压站', 'DN80', 'Lora', N'正常', 12, N'金卡智能', 20);

INSERT INTO EnergyMeasurement (MeterId, CollectTime, Value, Unit, DataQuality, FactoryId, NeedVerify)
VALUES
-- 电表1（MeterId=1）近10小时数据
(1, '2025-11-28 08:00:00', 1250.500, 'kWh', N'优', 1, 0),
(1, '2025-11-28 09:00:00', 1280.300, 'kWh', N'优', 1, 0),
(1, '2025-11-28 10:00:00', 1320.800, 'kWh', N'优', 1, 0),
(1, '2025-11-28 11:00:00', 1350.200, 'kWh', N'优', 1, 0),
(1, '2025-11-28 12:00:00', 1300.600, 'kWh', N'优', 1, 0),
(1, '2025-11-28 13:00:00', 1280.400, 'kWh', N'优', 1, 0),
(1, '2025-11-28 14:00:00', 1260.700, 'kWh', N'优', 1, 0),
(1, '2025-11-28 15:00:00', 1240.900, 'kWh', N'优', 1, 0),
(1, '2025-11-28 16:00:00', 1220.300, 'kWh', N'优', 1, 0),
(1, '2025-11-28 17:00:00', 1200.100, 'kWh', N'优', 1, 0),
-- 水表2（MeterId=2）近10小时数据
(2, '2025-11-28 08:00:00', 25.300, 'm?', N'优', 1, 0),
(2, '2025-11-28 09:00:00', 26.100, 'm?', N'优', 1, 0),
(2, '2025-11-28 10:00:00', 27.500, 'm?', N'优', 1, 0),
(2, '2025-11-28 11:00:00', 28.200, 'm?', N'优', 1, 0),
(2, '2025-11-28 12:00:00', 26.800, 'm?', N'优', 1, 0),
(2, '2025-11-28 13:00:00', 25.900, 'm?', N'优', 1, 0),
(2, '2025-11-28 14:00:00', 25.400, 'm?', N'优', 1, 0),
(2, '2025-11-28 15:00:00', 24.800, 'm?', N'优', 1, 0),
(2, '2025-11-28 16:00:00', 24.200, 'm?', N'优', 1, 0),
(2, '2025-11-28 17:00:00', 23.700, 'm?', N'优', 1, 0),
-- 蒸汽表3（MeterId=3）近10小时数据
(3, '2025-11-28 08:00:00', 5.200, 't', N'优', 1, 0),
(3, '2025-11-28 09:00:00', 5.500, 't', N'优', 1, 0),
(3, '2025-11-28 10:00:00', 5.800, 't', N'优', 1, 0),
(3, '2025-11-28 11:00:00', 6.100, 't', N'优', 1, 0),
(3, '2025-11-28 12:00:00', 5.700, 't', N'优', 1, 0),
(3, '2025-11-28 13:00:00', 5.400, 't', N'优', 1, 0),
(3, '2025-11-28 14:00:00', 5.100, 't', N'优', 1, 0),
(3, '2025-11-28 15:00:00', 4.900, 't', N'优', 1, 0),
(3, '2025-11-28 16:00:00', 4.600, 't', N'优', 1, 0),
(3, '2025-11-28 17:00:00', 4.300, 't', N'优', 1, 0),
-- 设备4（天然气）
(4, '2025-11-28 17:00:00', 85.300, 'm?', N'优', 1, 0),
-- 设备5-6（电、水）
(5, '2025-11-28 17:00:00', 950.200, 'kWh', N'优', 2, 0),
(6, '2025-11-28 17:00:00', 18.500, 'm?', N'优', 2, 0),
-- 设备7（蒸汽，故障状态）
(7, '2025-11-28 17:00:00', 0.000, 't', N'差', 2, 1),
-- 设备8-9（电、水）
(8, '2025-11-28 17:00:00', 680.400, 'kWh', N'优', 3, 0),
(9, '2025-11-28 17:00:00', 15.200, 'm?', N'优', 3, 0),
-- 设备10-12（电、水、天然气）
(10, '2025-11-28 17:00:00', 1250.800, 'kWh', N'优', 4, 0),
(11, '2025-11-28 17:00:00', 32.500, 'm?', N'优', 4, 0),
(12, '2025-11-28 17:00:00', 120.300, 'm?', N'优', 4, 0),
-- 设备13-14（电、水）
(13, '2025-11-28 17:00:00', 850.600, 'kWh', N'优', 5, 0),
(14, '2025-11-28 17:00:00', 22.800, 'm?', N'优', 5, 0),
-- 设备15-16（电、水）
(15, '2025-11-28 17:00:00', 520.300, 'kWh', N'优', 6, 0),
(16, '2025-11-28 17:00:00', 12.500, 'm?', N'优', 6, 0),
-- 设备17-19（电、水、天然气）
(17, '2025-11-28 17:00:00', 1850.200, 'kWh', N'优', 11, 0),
(18, '2025-11-28 17:00:00', 45.600, 'm?', N'优', 11, 0),
(19, '2025-11-28 17:00:00', 95.800, 'm?', N'优', 11, 0),
-- 设备20（电）
(20, '2025-11-28 17:00:00', 780.500, 'kWh', N'优', 16, 0),
-- 新插入的设备21-56（从上面插入的设备，假设从MeterId=21开始）
-- 工厂7的设备21-23
(21, '2025-11-28 17:00:00', 14.800, 'm?', N'优', 7, 0),
(22, '2025-11-28 17:00:00', 3.200, 't', N'优', 7, 0),
(23, '2025-11-28 17:00:00', 45.600, 'm?', N'优', 7, 0),
-- 工厂8的设备24-25
(24, '2025-11-28 17:00:00', 2.800, 't', N'优', 8, 0),
(25, '2025-11-28 17:00:00', 38.900, 'm?', N'优', 8, 0),
-- 工厂9的设备26-29
(26, '2025-11-28 17:00:00', 420.300, 'kWh', N'优', 9, 0),
(27, '2025-11-28 17:00:00', 10.200, 'm?', N'优', 9, 0),
(28, '2025-11-28 17:00:00', 2.200, 't', N'优', 9, 0),
(29, '2025-11-28 17:00:00', 28.500, 'm?', N'优', 9, 0),
-- 工厂10的设备30-33
(30, '2025-11-28 17:00:00', 380.600, 'kWh', N'优', 10, 0),
(31, '2025-11-28 17:00:00', 9.800, 'm?', N'优', 10, 0),
(32, '2025-11-28 17:00:00', 1.900, 't', N'优', 10, 0),
(33, '2025-11-28 17:00:00', 25.300, 'm?', N'优', 10, 0),
-- 工厂12的设备34-36
(34, '2025-11-28 17:00:00', 11.500, 'm?', N'优', 12, 0),
(35, '2025-11-28 17:00:00', 2.500, 't', N'优', 12, 0),
(36, '2025-11-28 17:00:00', 42.800, 'm?', N'优', 12, 0),
-- 工厂13的设备37-39
(37, '2025-11-28 17:00:00', 320.400, 'kWh', N'优', 13, 0),
(38, '2025-11-28 17:00:00', 8.500, 'm?', N'优', 13, 0),
(39, '2025-11-28 17:00:00', 22.600, 'm?', N'优', 13, 0),
-- 工厂14的设备40-43
(40, '2025-11-28 17:00:00', 280.200, 'kWh', N'优', 14, 0),
(41, '2025-11-28 17:00:00', 7.800, 'm?', N'优', 14, 0),
(42, '2025-11-28 17:00:00', 1.600, 't', N'优', 14, 0),
(43, '2025-11-28 17:00:00', 20.800, 'm?', N'优', 14, 0),
-- 工厂15的设备44-46
(44, '2025-11-28 17:00:00', 6.500, 'm?', N'优', 15, 0),
(45, '2025-11-28 17:00:00', 1.400, 't', N'优', 15, 0),
(46, '2025-11-28 17:00:00', 18.200, 'm?', N'优', 15, 0),
-- 工厂17的设备47-49
(47, '2025-11-28 17:00:00', 8.200, 'm?', N'优', 17, 0),
(48, '2025-11-28 17:00:00', 1.800, 't', N'优', 17, 0),
(49, '2025-11-28 17:00:00', 26.500, 'm?', N'优', 17, 0),
-- 工厂18的设备50-53
(50, '2025-11-28 17:00:00', 250.800, 'kWh', N'优', 18, 0),
(51, '2025-11-28 17:00:00', 6.200, 'm?', N'优', 18, 0),
(52, '2025-11-28 17:00:00', 1.300, 't', N'优', 18, 0),
(53, '2025-11-28 17:00:00', 16.800, 'm?', N'优', 18, 0),
-- 工厂19的设备54-57
(54, '2025-11-28 17:00:00', 290.600, 'kWh', N'优', 19, 0),
(55, '2025-11-28 17:00:00', 7.500, 'm?', N'优', 19, 0),
(56, '2025-11-28 17:00:00', 1.500, 't', N'优', 19, 0),
(57, '2025-11-28 17:00:00', 23.200, 'm?', N'优', 19, 0),
-- 工厂20的设备58-61
(58, '2025-11-28 17:00:00', 520.300, 'kWh', N'优', 20, 0),
(59, '2025-11-28 17:00:00', 13.800, 'm?', N'优', 20, 0),
(60, '2025-11-28 17:00:00', 2.800, 't', N'优', 20, 0),
(61, '2025-11-28 17:00:00', 38.500, 'm?', N'优', 20, 0);

GO

--插入的脏数据，测试数据
INSERT INTO EnergyMeter (MeterCode, EnergyType, FactoryId, RunStatus) VALUES
('EM-ELEC-001', '电', 1, '正常'),
('EM-WATER-001', '水', 2, '正常');

-- 再插数据 (注意最后一条，我故意设为 NeedVerify = 1)
INSERT INTO EnergyMeasurement (MeterId, CollectTime, Value, Unit, DataQuality, FactoryId, NeedVerify) VALUES
(1, '2025-11-30 08:00:00', 120.5, 'kWh', '优', 1, 0), -- 正常
(1, '2025-11-30 09:00:00', 130.2, 'kWh', '优', 1, 0), -- 正常
(1, '2025-11-30 10:00:00', 9999.9, 'kWh', '差', 1, 1); -- 异常数据！待核实！

-- 3. 创建“能耗报表视图” (简化 Python 查询)
-- 作用：把 ID 变成人能看懂的名字，专供能源管理员查看
GO


/* 近五天统计日期区间 */
DECLARE @StartDate DATE = '2025-11-27';
DECLARE @EndDate   DATE = '2025-12-01';

;WITH Dates AS (
    SELECT @StartDate AS StatDate
    UNION ALL
    SELECT DATEADD(DAY, 1, StatDate)
    FROM Dates
    WHERE StatDate < @EndDate
),
/* 每个厂区的“日均基准量”(示例，可按需调)：
   ElecBase(kWh), WaterBase(m3), SteamBase(t), GasBase(m3)
*/
Factories AS (
    SELECT *
    FROM (VALUES
        (1 , 46000, 260, 55,  90),
        (2 , 24000, 180, 40,  60),
        (3 , 18000, 150,  0,   0),
        (4 , 28000, 210,  0,  75),
        (5 , 22000, 190,  0,   0),
        (6 , 15000, 120,  0,   0),
        (7 ,     0, 140, 32,  46),
        (8 ,     0,   0, 28,  39),
        (9 , 12000, 100, 22,  29),
        (10, 11000,  95, 19,  26),
        (11, 30000, 230,  0,  70),
        (12,     0, 170, 25,  43),
        (13,  9000,  85,  0,  23),
        (14,  8000,  78, 16,  21),
        (15,     0,  70, 14,  18),
        (16, 14000,   0,  0,   0),
        (17,     0,  88, 18,  27),
        (18,  7000,  62, 13,  17),
        (19,  8200,  75, 15,  23),
        (20, 16000, 105, 28,  38)
    ) AS v(FactoryId, ElecBase, WaterBase, SteamBase, GasBase)
),
/* 四个能源类型展开成行，并给出基准量&参考价格(示例) */
EnergyExpand AS (
    SELECT FactoryId, N'电' AS EnergyType, ElecBase  AS BaseValue, CAST(0.8500 AS DECIMAL(10,4)) AS Price
    FROM Factories
    UNION ALL
    SELECT FactoryId, N'水', WaterBase, CAST(3.2000 AS DECIMAL(10,4))  -- 例：水单价
    FROM Factories
    UNION ALL
    SELECT FactoryId, N'蒸汽', SteamBase, CAST(210.0000 AS DECIMAL(10,4)) -- 例：蒸汽单价
    FROM Factories
    UNION ALL
    SELECT FactoryId, N'天然气', GasBase, CAST(2.6000 AS DECIMAL(10,4))  -- 例：气单价
    FROM Factories
)
/* 插入近五天峰谷统计 */
INSERT INTO PeakValleyEnergy
(
    EnergyType, FactoryId, StatDate,
    SharpPeriodValue, PeakPeriodValue, FlatPeriodValue, ValleyPeriodValue,
    TotalValue, PeakValleyPrice, EnergyCost
)
SELECT
    e.EnergyType,
    e.FactoryId,
    d.StatDate,

    /* 当天总量 = 基准量 * (1 + 2% * 天序号) * (1 + 轻微厂区扰动) */
    CAST(t.TotalValue * 0.12 AS DECIMAL(18,3)) AS SharpPeriodValue, -- 尖峰 12%
    CAST(t.TotalValue * 0.38 AS DECIMAL(18,3)) AS PeakPeriodValue,  -- 高峰 38%
    CAST(t.TotalValue * 0.32 AS DECIMAL(18,3)) AS FlatPeriodValue,  -- 平段 32%
    CAST(t.TotalValue * 0.18 AS DECIMAL(18,3)) AS ValleyPeriodValue,-- 低谷 18%

    CAST(t.TotalValue AS DECIMAL(18,3)) AS TotalValue,
    e.Price AS PeakValleyPrice,
    CAST(t.TotalValue * e.Price AS DECIMAL(18,2)) AS EnergyCost
FROM EnergyExpand e
CROSS JOIN Dates d
CROSS APPLY (
    SELECT
        /* 天序号：0~4 */
        DATEDIFF(DAY, @StartDate, d.StatDate) AS DayIdx,
        /* 厂区扰动：按厂区号做个稳定微扰(±3%以内) */
        (1.0 + ((e.FactoryId % 7) - 3) * 0.01) AS FactoryBump
) x
CROSS APPLY (
    SELECT
        /* 若某厂区该能源基准为0，则当天总量为NULL -> 不插 */
        CASE
            WHEN e.BaseValue <= 0 THEN NULL
            ELSE e.BaseValue * (1.0 + x.DayIdx * 0.02) * x.FactoryBump
        END AS TotalValue
) t
WHERE t.TotalValue IS NOT NULL
  AND NOT EXISTS (
      SELECT 1
      FROM PeakValleyEnergy p
      WHERE p.EnergyType = e.EnergyType
        AND p.FactoryId  = e.FactoryId
        AND p.StatDate   = d.StatDate
  )
OPTION (MAXRECURSION 10);

-- 插入的脏数据，为系统管理员服务
INSERT INTO ElectricityPricePolicy (TimeStart, TimeEnd, PriceType)
SELECT '00:00', '08:00', 'Valley' WHERE NOT EXISTS(SELECT 1 FROM ElectricityPricePolicy);
INSERT INTO ElectricityPricePolicy (TimeStart, TimeEnd, PriceType)
SELECT '08:00', '12:00', 'Peak' WHERE NOT EXISTS(SELECT 1 FROM ElectricityPricePolicy WHERE TimeStart='08:00');
INSERT INTO ElectricityPricePolicy (TimeStart, TimeEnd, PriceType)
SELECT '12:00', '00:00', 'Flat' WHERE NOT EXISTS(SELECT 1 FROM ElectricityPricePolicy WHERE TimeStart='12:00');


